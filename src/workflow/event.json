{
  "version": 2,
  "objectType": "event",
  "context": "event/context",
  "description": "Жизненный цикл мероприятия",
  "rbac": {
    "visible": true,
    "title": "Мероприятия"
  },
  "actions": {
    "initialActions": {
      "create": {
        "title": "Добавить",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Добавить мероприятие"
          }
        },
        "functions": [
          {
            "$workflow-object-create": {
              "objectType": "event",
              "query": "event/add",
              "variables": {
                "data": {
                  "createdBy": {
                    "$active-user": {
                      "field": "_id"
                    }
                  }
                }
              },
              "responsePath": "event",
              "resultPath": "$newEvent"
            }
          },
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Добавление мероприятия",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          },
          {
            "$assign-response": {
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "$newEvent.id"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "new"
        }
      },
      "add_draft": {
        "title": "Добавить",
        "grants": {
          "rbac": {
            "enabled": true,
            "permissionCode": "event.create"
          }
        },
        "functions": [
          {
            "$assign-context": {
              "path": "$eventData",
              "data": {
                "$merge": {
                  "data": [
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '' || obj[key] === null) && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.eventData.commonInfo"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '' || obj[key] === null) && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.eventData.workingHours"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "result = {organizers: [], curators: []}; organizers.forEach((organizer) => {result.organizers.push({ organizerId: organizer.organizerId });}); curators.forEach((curator) => {result.curators.push({ userId: curator.userId });}); return result;",
                        "args": {
                          "organizers": {
                            "$from-context": {
                              "path": "data.eventData.organizers"
                            }
                          },
                          "curators": {
                            "$from-context": {
                              "path": "data.eventData.curators"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "$ref:js:prepare-event-files",
                        "args": {
                          "data": {
                            "$from-context": {
                              "path": "data.eventData.attachments"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "$workflow-object-create": {
              "objectType": "event",
              "query": "event/add",
              "variables": {
                "data": {
                  "$assign-object": {
                    "path": "createdBy",
                    "data": {
                      "$active-user": {
                        "field": "_id"
                      }
                    },
                    "object": {
                      "$from-context": {
                        "path": "$eventData"
                      }
                    }
                  }
                }
              },
              "responsePath": "event",
              "resultPath": "$draftEvent"
            }
          },
          {
            "$if": {
              "condition": {
                "$not-empty": {
                  "data": {
                    "$from-context": {
                      "path": "data.services"
                    }
                  }
                }
              },
              "then": {
                "$waterfall": {
                  "arrayFunctions": [
                    {
                      "$assign-context": {
                        "path": "$serviceData",
                        "data": {
                          "services": {
                            "$from-context": {
                              "path": "data.services"
                            }
                          },
                          "type": {
                            "$from-context": {
                              "path": "data.type"
                            }
                          },
                          "eventId": {
                            "$from-context": {
                              "path": "$draftEvent.id.0"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$workflow-run": {
                        "workflowName": "additional_facilities",
                        "action": "mass_add",
                        "data": {
                          "$from-context": {
                            "path": "$serviceData"
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "$if": {
              "condition": {
                "$not-empty": {
                  "data": {
                    "$from-context": {
                      "path": "data.rooms"
                    }
                  }
                }
              },
              "then": {
                "$waterfall": {
                  "arrayFunctions": [
                    {
                      "$assign-context": {
                        "path": "$bookingData",
                        "data": {
                          "rooms": {
                            "$from-context": {
                              "path": "data.rooms"
                            }
                          },
                          "eventId": {
                            "$from-context": {
                              "path": "$draftEvent.id.0"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$workflow-run": {
                        "workflowName": "booking",
                        "action": "mass_add",
                        "data": {
                          "$from-context": {
                            "path": "$bookingData"
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "draft"
        }
      },
      "add_copy": {
        "title": "Добавить копию мероприятия",
        "grants": {
          "rbac": {
            "enabled": false
          },
          "system": true
        },
        "functions": [
          {
            "$workflow-object-create": {
              "objectType": "event",
              "query": "event/add",
              "variables": {
                "data": {
                  "$from-context": {
                    "path": "data.eventData"
                  }
                }
              },
              "responsePath": "event",
              "resultPath": "$copyEvent"
            }
          },
          {
            "$workflow-run-from-collection": {
              "workflowName": "booking",
              "action": "copy",
              "collection": {
                "$array-map": {
                  "array": {
                    "$from-context": {
                      "path": "data.bookings"
                    }
                  },
                  "map": {
                    "$assign-object": {
                      "path": "",
                      "data": {
                        "discountOrMarkupFlag": "no",
                        "eventId": {
                          "$from-context": {
                            "path": "$copyEvent.id.0"
                          }
                        }
                      },
                      "object": {
                        "$from-context": {
                          "path": "$data"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$workflow-run-from-collection": {
              "workflowName": "additional_facilities",
              "action": "copy",
              "collection": {
                "$array-map": {
                  "array": {
                    "$from-context": {
                      "path": "data.services"
                    }
                  },
                  "map": {
                    "$assign-object": {
                      "path": "",
                      "data": {
                        "discountOrMarkupFlag": "no",
                        "eventId": {
                          "$from-context": {
                            "path": "$copyEvent.id.0"
                          }
                        }
                      },
                      "object": {
                        "$from-context": {
                          "path": "$data"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$workflow-run": {
              "workflowName": "request",
              "action": "add",
              "data": {
                "$assign-object": {
                  "path": "",
                  "data": {
                    "type": {
                      "$from-context": {
                        "path": "data.requestCode"
                      }
                    },
                    "eventId": {
                      "$from-context": {
                        "path": "$copyEvent.id.0"
                      }
                    },
                    "changeEventId": {
                      "$from-context": {
                        "path": "data.initialEventId"
                      }
                    },
                    "creatorId": {
                      "$active-user": {
                        "field": "_id"
                      }
                    },
                    "createDate": {
                      "$datetime-now": {}
                    }
                  },
                  "object": {}
                }
              }
            }
          }
        ],
        "results": {
          "conditional": [
            {
              "conditions": {
                "$from-context": {
                  "path": "data.eventData.preliminary"
                }
              },
              "state": "pre_booking"
            },
            {
              "conditions": {
                "===": {
                  "operand1": {
                    "$from-context": {
                      "path": "data.state"
                    }
                  },
                  "operand2": "pre_booking"
                }
              },
              "state": "pre_booking"
            },
            {
              "conditions": {
                "===": {
                  "operand1": {
                    "$from-context": {
                      "path": "data.state"
                    }
                  },
                  "operand2": "requested"
                }
              },
              "state": "requested"
            },
            {
              "conditions": {
                "===": {
                  "operand1": {
                    "$from-context": {
                      "path": "data.state"
                    }
                  },
                  "operand2": "task_received"
                }
              },
              "state": "task_received"
            },
            {
              "conditions": {
                "===": {
                  "operand1": {
                    "$from-context": {
                      "path": "data.state"
                    }
                  },
                  "operand2": "agreed"
                }
              },
              "state": "agreed"
            },
            {
              "conditions": {
                "===": {
                  "operand1": {
                    "$from-context": {
                      "path": "data.state"
                    }
                  },
                  "operand2": "check_in"
                }
              },
              "state": "check_in"
            }
          ],
          "unconditional": "draft"
        }
      },
      "copy": {
        "title": "Копировать мероприятие",
        "grants": {
          "rbac": {
            "enabled": false
          },
          "system": true
        },
        "functions": [
          {
            "$api-data-query": {
              "query": "event/get_for_copy",
              "variables": {
                "id": {
                  "$from-context": {
                    "path": "data.id"
                  }
                }
              },
              "responsePath": "items.0",
              "resultPath": "$estimate"
            }
          },
          {
            "$workflow-object-create": {
              "objectType": "event",
              "query": "event/add",
              "variables": {
                "data": {
                  "$assign-object": {
                    "path": "",
                    "data": {
                      "creatorId": {
                        "$from-context": {
                          "path": "data.creatorId"
                        }
                      },
                      "number": {
                        "$sum": {
                          "terms": [
                            1,
                            {
                              "$api-data-query": {
                                "query": "event/get_actual",
                                "responsePath": "pagination.count"
                              }
                            }
                          ]
                        }
                      },
                      "discountOrMarkupFlag": "no",
                      "discountOrMarkup": 0,
                      "totalEventCost": 0,
                      "totalEventCostWithDiscountOrMarkup": 0
                    },
                    "object": {
                      "$from-context": {
                        "path": "$estimate"
                      }
                    }
                  }
                }
              },
              "responsePath": "event",
              "resultPath": "$copyEvent"
            }
          },
          {
            "$workflow-run": {
              "workflowName": "additional_facilities",
              "action": "mass_add",
              "data": {
                "services": {
                  "$array-pluck": {
                    "array": {
                      "$api-data-query": {
                        "query": "additional_facilities/get_for_event_copy",
                        "variables": {
                          "eventId": {
                            "$from-context": {
                              "path": "data.id"
                            }
                          }
                        },
                        "responsePath": "items"
                      }
                    },
                    "key": "serviceId"
                  }
                },
                "type": "additional_service",
                "eventId": {
                  "$from-context": {
                    "path": "$copyEvent.id.0"
                  }
                }
              }
            }
          },
          {
            "$array-map": {
              "array": {
                "$api-data-query": {
                  "query": "booking/get_for_event_copy",
                  "variables": {
                    "eventId": {
                      "$from-context": {
                        "path": "data.id"
                      }
                    }
                  },
                  "responsePath": "items"
                }
              },
              "map": {
                "$workflow-run": {
                  "workflowName": "booking",
                  "action": "add",
                  "data": {
                    "$assign-object": {
                      "path": "",
                      "data": {
                        "eventId": {
                          "$from-context": {
                            "path": "$copyEvent.id.0"
                          }
                        },
                        "partial": false,
                        "file": {
                          "create_date": null,
                          "name": null,
                          "size": null,
                          "_id": null
                        },
                        "discountOrMarkupFlag": "no"
                      },
                      "object": {
                        "$from-context": {
                          "path": "$data"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "pre_booking"
        }
      }
    },
    "globalActions": {
      "list": {
        "title": "Просмотреть реестр мероприятий",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Просмотреть реестр мероприятий"
          }
        },
        "views": {
          "gui": {
            "path": "event/list",
            "mode": "form",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "event/list",
            "event_type/get_for_dropdown",
            "user/get_for_dropdown",
            "event/get_new",
            "partner/get_for_dropdown"
          ]
        }
      },
      "list-employment-schedule": {
        "title": "Просмотреть график занятости",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Просмотреть график занятости"
          }
        },
        "views": {
          "gui": {
            "path": "event/list_employment_schedule",
            "mode": "form",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "room/get_for_employment_schedule",
            "partner/get_for_dropdown",
            "event/get_name_actual",
            "booking/employment_schedule"
          ]
        }
      },
      "add-document-upload": {
        "title": "Загрузка вложений для мероприятия",
        "description": "Загрузка вложений для мероприятия ",
        "grants": {
          "rbac": {
            "enabled": true,
            "permissionCode": "event.create"
          }
        }
      },
      "export-estimate": {
        "title": "Сформировать смету",
        "description": "Выгрузить смету в excel-файл",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Сформировать смету"
          }
        },
        "views": {},
        "functions": [
          {
            "$api-data-query": {
              "query": "event/get",
              "variables": {
                "id": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "items.0",
              "resultPath": "$estimate"
            }
          },
          {
            "$api-data-query": {
              "query": "booking/get_for_estimate",
              "variables": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "items",
              "resultPath": "$mainEstimate"
            }
          },
          {
            "$api-data-query": {
              "query": "booking/get_for_estimate_additional_facilities",
              "variables": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "items",
              "resultPath": "$estimateAdditionalFacilities"
            }
          },
          {
            "$assign-context": {
              "path": "$tableEstimate",
              "data": {
                "$apply-func": {
                  "func": " const merged = data.flat(Infinity); let result = [...new Set(merged)]; return result",
                  "args": {
                    "data": {
                      "$array-map": {
                        "array": {
                          "$from-context": {
                            "path": "$estimateAdditionalFacilities"
                          }
                        },
                        "map": {
                          "$array-map": {
                            "array": {
                              "$from-context": {
                                "path": "$data.additionalFacilities"
                              }
                            },
                            "map": {
                              "$assign-object": {
                                "path": "main",
                                "data": {
                                  "$array-filter": {
                                    "array": {
                                      "$from-context": {
                                        "path": "$mainEstimate"
                                      }
                                    },
                                    "filter": {
                                      "===": {
                                        "operand1": {
                                          "$from-context": {
                                            "path": "$data.0.id_additionalFacilities"
                                          }
                                        },
                                        "operand2": {
                                          "$from-context": {
                                            "path": "$data.2.id"
                                          }
                                        }
                                      }
                                    }
                                  }
                                },
                                "object": {
                                  "$from-context": {
                                    "path": "$data.1"
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$assign-context": {
              "path": "$tableEstimate",
              "data": {
                "$array-filter": {
                  "array": {
                    "$apply-func": {
                      "func": " const merged = data.flat(Infinity); let result = [...new Set(merged)]; return result",
                      "args": {
                        "data": {
                          "$array-push": {
                            "array": {
                              "$array-map": {
                                "array": {
                                  "$from-context": {
                                    "path": "$tableEstimate"
                                  }
                                },
                                "map": {
                                  "$waterfall": {
                                    "arrayFunctions": [
                                      {
                                        "$if": {
                                          "condition": {
                                            "$not-empty": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$data.main.0.installationDates"
                                                }
                                              }
                                            }
                                          },
                                          "then": {
                                            "$array-map": {
                                              "array": {
                                                "$from-context": {
                                                  "path": "$data.main.0.installationDates"
                                                }
                                              },
                                              "map": {
                                                "$assign-object": {
                                                  "object": {},
                                                  "data": {
                                                    "date": {
                                                      "$from-context": {
                                                        "path": "$data.1.startTime"
                                                      }
                                                    },
                                                    "periodDay": {
                                                      "$date-format": {
                                                        "template": "DD.MM.YYYY",
                                                        "nameZone": "ETC/GMT+0",
                                                        "value": {
                                                          "$date-add": {
                                                            "date": {
                                                              "$from-context": {
                                                                "path": "$data.1.startTime"
                                                              }
                                                            },
                                                            "number": 3,
                                                            "interval": "h"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "time": {
                                                      "$replace": {
                                                        "template": "{{0}} - {{1}}",
                                                        "data": [
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.startTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          },
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.endTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          }
                                                        ]
                                                      }
                                                    },
                                                    "room": {
                                                      "$from-context": {
                                                        "path": "$data.0.main.0.name"
                                                      }
                                                    },
                                                    "floor": {
                                                      "$if": {
                                                        "condition": {
                                                          "===": {
                                                            "operand1": {
                                                              "$from-context": {
                                                                "path": "$data.0.main.0.rooms.0.room.floor"
                                                              }
                                                            },
                                                            "operand2": "open_area"
                                                          }
                                                        },
                                                        "then": "Открытая выставочная площадь",
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.main.0.rooms.0.room.floor"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "period": "Монтаж",
                                                    "typeService": {
                                                      "$if": {
                                                        "condition": {
                                                          "$in": {
                                                            "array": {
                                                              "$from-context": {
                                                                "path": "$data.0.bookingPeriod"
                                                              }
                                                            },
                                                            "value": "installation"
                                                          }
                                                        },
                                                        "then": {
                                                          "$if": {
                                                            "condition": {
                                                              "$not-empty": {
                                                                "data": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.additionalService"
                                                                  }
                                                                }
                                                              }
                                                            },
                                                            "then": "Дополнительная услуга",
                                                            "else": {
                                                              "$if": {
                                                                "condition": {
                                                                  "$not-empty": {
                                                                    "data": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.equipment"
                                                                      }
                                                                    }
                                                                  }
                                                                },
                                                                "then": "Оборудование",
                                                                "else": {
                                                                  "$if": {
                                                                    "condition": {
                                                                      "$not-empty": {
                                                                        "data": {
                                                                          "$from-context": {
                                                                            "path": "$data.0.furniture"
                                                                          }
                                                                        }
                                                                      }
                                                                    },
                                                                    "then": "Мебель",
                                                                    "else": "Нет услуги"
                                                                  }
                                                                }
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "service": {
                                                      "$if": {
                                                        "condition": {
                                                          "$in": {
                                                            "array": {
                                                              "$from-context": {
                                                                "path": "$data.0.bookingPeriod"
                                                              }
                                                            },
                                                            "value": "installation"
                                                          }
                                                        },
                                                        "then": {
                                                          "$if": {
                                                            "condition": {
                                                              "$not-empty": {
                                                                "data": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.additionalService"
                                                                  }
                                                                }
                                                              }
                                                            },
                                                            "then": {
                                                              "$from-context": {
                                                                "path": "$data.0.additionalService.name"
                                                              }
                                                            },
                                                            "else": {
                                                              "$if": {
                                                                "condition": {
                                                                  "$not-empty": {
                                                                    "data": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.equipment"
                                                                      }
                                                                    }
                                                                  }
                                                                },
                                                                "then": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.equipment.name"
                                                                  }
                                                                },
                                                                "else": {
                                                                  "$if": {
                                                                    "condition": {
                                                                      "$not-empty": {
                                                                        "data": {
                                                                          "$from-context": {
                                                                            "path": "$data.0.furniture"
                                                                          }
                                                                        }
                                                                      }
                                                                    },
                                                                    "then": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.furniture.name"
                                                                      }
                                                                    },
                                                                    "else": "Нет услуги"
                                                                  }
                                                                }
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "unitPrice": {
                                                      "$if": {
                                                        "condition": {
                                                          "$not-empty": {
                                                            "data": {
                                                              "$from-context": {
                                                                "path": "$data.0.unitPriceWithDiscountOrMarkup"
                                                              }
                                                            }
                                                          }
                                                        },
                                                        "then": {
                                                          "$from-context": {
                                                            "path": "$data.0.unitPriceWithDiscountOrMarkup"
                                                          }
                                                        },
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.unitPrice"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "quantity": {
                                                      "$from-context": {
                                                        "path": "$data.0.quantity"
                                                      }
                                                    },
                                                    "comment": {
                                                      "$from-context": {
                                                        "path": "$data.0.bookingComment"
                                                      }
                                                    }
                                                  },
                                                  "path": ""
                                                }
                                              }
                                            }
                                          },
                                          "else": {}
                                        }
                                      },
                                      {
                                        "$array-map": {
                                          "array": {
                                            "$from-context": {
                                              "path": "$data.main.0.eventDates"
                                            }
                                          },
                                          "map": {
                                            "$assign-object": {
                                              "object": {},
                                              "data": {
                                                "date": {
                                                  "$from-context": {
                                                    "path": "$data.1.startTime"
                                                  }
                                                },
                                                "periodDay": {
                                                  "$date-format": {
                                                    "template": "DD.MM.YYYY",
                                                    "nameZone": "ETC/GMT+0",
                                                    "value": {
                                                      "$date-add": {
                                                        "date": {
                                                          "$from-context": {
                                                            "path": "$data.1.startTime"
                                                          }
                                                        },
                                                        "number": 3,
                                                        "interval": "h"
                                                      }
                                                    }
                                                  }
                                                },
                                                "time": {
                                                  "$replace": {
                                                    "template": "{{0}} - {{1}}",
                                                    "data": [
                                                      {
                                                        "$date-format": {
                                                          "template": "HH:mm",
                                                          "nameZone": "ETC/GMT+0",
                                                          "value": {
                                                            "$date-add": {
                                                              "date": {
                                                                "$from-context": {
                                                                  "path": "$data.1.startTime"
                                                                }
                                                              },
                                                              "number": 3,
                                                              "interval": "h"
                                                            }
                                                          }
                                                        }
                                                      },
                                                      {
                                                        "$date-format": {
                                                          "template": "HH:mm",
                                                          "nameZone": "ETC/GMT+0",
                                                          "value": {
                                                            "$date-add": {
                                                              "date": {
                                                                "$from-context": {
                                                                  "path": "$data.1.endTime"
                                                                }
                                                              },
                                                              "number": 3,
                                                              "interval": "h"
                                                            }
                                                          }
                                                        }
                                                      }
                                                    ]
                                                  }
                                                },
                                                "room": {
                                                  "$from-context": {
                                                    "path": "$data.0.main.0.name"
                                                  }
                                                },
                                                "floor": {
                                                  "$if": {
                                                    "condition": {
                                                      "===": {
                                                        "operand1": {
                                                          "$from-context": {
                                                            "path": "$data.0.main.0.rooms.0.room.floor"
                                                          }
                                                        },
                                                        "operand2": "open_area"
                                                      }
                                                    },
                                                    "then": "Открытая выставочная площадь",
                                                    "else": {
                                                      "$from-context": {
                                                        "path": "$data.0.main.0.rooms.0.room.floor"
                                                      }
                                                    }
                                                  }
                                                },
                                                "period": "Мероприятие",
                                                "typeService": {
                                                  "$if": {
                                                    "condition": {
                                                      "$in": {
                                                        "array": {
                                                          "$from-context": {
                                                            "path": "$data.0.bookingPeriod"
                                                          }
                                                        },
                                                        "value": "event"
                                                      }
                                                    },
                                                    "then": {
                                                      "$if": {
                                                        "condition": {
                                                          "$not-empty": {
                                                            "data": {
                                                              "$from-context": {
                                                                "path": "$data.0.additionalService"
                                                              }
                                                            }
                                                          }
                                                        },
                                                        "then": "Дополнительная услуга",
                                                        "else": {
                                                          "$if": {
                                                            "condition": {
                                                              "$not-empty": {
                                                                "data": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.equipment"
                                                                  }
                                                                }
                                                              }
                                                            },
                                                            "then": "Оборудование",
                                                            "else": {
                                                              "$if": {
                                                                "condition": {
                                                                  "$not-empty": {
                                                                    "data": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.furniture"
                                                                      }
                                                                    }
                                                                  }
                                                                },
                                                                "then": "Мебель",
                                                                "else": "Нет услуги"
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    }
                                                  }
                                                },
                                                "service": {
                                                  "$if": {
                                                    "condition": {
                                                      "$in": {
                                                        "array": {
                                                          "$from-context": {
                                                            "path": "$data.0.bookingPeriod"
                                                          }
                                                        },
                                                        "value": "event"
                                                      }
                                                    },
                                                    "then": {
                                                      "$if": {
                                                        "condition": {
                                                          "$not-empty": {
                                                            "data": {
                                                              "$from-context": {
                                                                "path": "$data.0.additionalService"
                                                              }
                                                            }
                                                          }
                                                        },
                                                        "then": {
                                                          "$from-context": {
                                                            "path": "$data.0.additionalService.name"
                                                          }
                                                        },
                                                        "else": {
                                                          "$if": {
                                                            "condition": {
                                                              "$not-empty": {
                                                                "data": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.equipment"
                                                                  }
                                                                }
                                                              }
                                                            },
                                                            "then": {
                                                              "$from-context": {
                                                                "path": "$data.0.equipment.name"
                                                              }
                                                            },
                                                            "else": {
                                                              "$if": {
                                                                "condition": {
                                                                  "$not-empty": {
                                                                    "data": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.furniture"
                                                                      }
                                                                    }
                                                                  }
                                                                },
                                                                "then": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.furniture.name"
                                                                  }
                                                                },
                                                                "else": "Нет услуги"
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    }
                                                  }
                                                },
                                                "unitPrice": {
                                                  "$if": {
                                                    "condition": {
                                                      "$not-empty": {
                                                        "data": {
                                                          "$from-context": {
                                                            "path": "$data.0.unitPriceWithDiscountOrMarkup"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "then": {
                                                      "$from-context": {
                                                        "path": "$data.0.unitPriceWithDiscountOrMarkup"
                                                      }
                                                    },
                                                    "else": {
                                                      "$from-context": {
                                                        "path": "$data.0.unitPrice"
                                                      }
                                                    }
                                                  }
                                                },
                                                "quantity": {
                                                  "$from-context": {
                                                    "path": "$data.0.quantity"
                                                  }
                                                },
                                                "comment": {
                                                  "$from-context": {
                                                    "path": "$data.0.bookingComment"
                                                  }
                                                }
                                              },
                                              "path": ""
                                            }
                                          }
                                        }
                                      },
                                      {
                                        "$if": {
                                          "condition": {
                                            "$not-empty": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$data.main.0.deinstallationDates"
                                                }
                                              }
                                            }
                                          },
                                          "then": {
                                            "$array-map": {
                                              "array": {
                                                "$from-context": {
                                                  "path": "$data.main.0.deinstallationDates"
                                                }
                                              },
                                              "map": {
                                                "$assign-object": {
                                                  "object": {},
                                                  "data": {
                                                    "date": {
                                                      "$from-context": {
                                                        "path": "$data.1.startTime"
                                                      }
                                                    },
                                                    "periodDay": {
                                                      "$date-format": {
                                                        "template": "DD.MM.YYYY",
                                                        "nameZone": "ETC/GMT+0",
                                                        "value": {
                                                          "$date-add": {
                                                            "date": {
                                                              "$from-context": {
                                                                "path": "$data.1.startTime"
                                                              }
                                                            },
                                                            "number": 3,
                                                            "interval": "h"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "time": {
                                                      "$replace": {
                                                        "template": "{{0}} - {{1}}",
                                                        "data": [
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.startTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          },
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.endTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          }
                                                        ]
                                                      }
                                                    },
                                                    "room": {
                                                      "$from-context": {
                                                        "path": "$data.0.main.0.name"
                                                      }
                                                    },
                                                    "floor": {
                                                      "$if": {
                                                        "condition": {
                                                          "===": {
                                                            "operand1": {
                                                              "$from-context": {
                                                                "path": "$data.0.main.0.rooms.0.room.floor"
                                                              }
                                                            },
                                                            "operand2": "open_area"
                                                          }
                                                        },
                                                        "then": "Открытая выставочная площадь",
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.main.0.rooms.0.room.floor"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "period": "Демонтаж",
                                                    "typeService": {
                                                      "$if": {
                                                        "condition": {
                                                          "$in": {
                                                            "array": {
                                                              "$from-context": {
                                                                "path": "$data.0.bookingPeriod"
                                                              }
                                                            },
                                                            "value": "deinstallation"
                                                          }
                                                        },
                                                        "then": {
                                                          "$if": {
                                                            "condition": {
                                                              "$not-empty": {
                                                                "data": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.additionalService"
                                                                  }
                                                                }
                                                              }
                                                            },
                                                            "then": "Дополнительная услуга",
                                                            "else": {
                                                              "$if": {
                                                                "condition": {
                                                                  "$not-empty": {
                                                                    "data": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.equipment"
                                                                      }
                                                                    }
                                                                  }
                                                                },
                                                                "then": "Оборудование",
                                                                "else": {
                                                                  "$if": {
                                                                    "condition": {
                                                                      "$not-empty": {
                                                                        "data": {
                                                                          "$from-context": {
                                                                            "path": "$data.0.furniture"
                                                                          }
                                                                        }
                                                                      }
                                                                    },
                                                                    "then": "Мебель",
                                                                    "else": "Нет услуги"
                                                                  }
                                                                }
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "service": {
                                                      "$if": {
                                                        "condition": {
                                                          "$in": {
                                                            "array": {
                                                              "$from-context": {
                                                                "path": "$data.0.bookingPeriod"
                                                              }
                                                            },
                                                            "value": "deinstallation"
                                                          }
                                                        },
                                                        "then": {
                                                          "$if": {
                                                            "condition": {
                                                              "$not-empty": {
                                                                "data": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.additionalService"
                                                                  }
                                                                }
                                                              }
                                                            },
                                                            "then": {
                                                              "$from-context": {
                                                                "path": "$data.0.additionalService.name"
                                                              }
                                                            },
                                                            "else": {
                                                              "$if": {
                                                                "condition": {
                                                                  "$not-empty": {
                                                                    "data": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.equipment"
                                                                      }
                                                                    }
                                                                  }
                                                                },
                                                                "then": {
                                                                  "$from-context": {
                                                                    "path": "$data.0.equipment.name"
                                                                  }
                                                                },
                                                                "else": {
                                                                  "$if": {
                                                                    "condition": {
                                                                      "$not-empty": {
                                                                        "data": {
                                                                          "$from-context": {
                                                                            "path": "$data.0.furniture"
                                                                          }
                                                                        }
                                                                      }
                                                                    },
                                                                    "then": {
                                                                      "$from-context": {
                                                                        "path": "$data.0.furniture.name"
                                                                      }
                                                                    },
                                                                    "else": "Нет услуги"
                                                                  }
                                                                }
                                                              }
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "unitPrice": {
                                                      "$if": {
                                                        "condition": {
                                                          "$not-empty": {
                                                            "data": {
                                                              "$from-context": {
                                                                "path": "$data.0.unitPriceWithDiscountOrMarkup"
                                                              }
                                                            }
                                                          }
                                                        },
                                                        "then": {
                                                          "$from-context": {
                                                            "path": "$data.0.unitPriceWithDiscountOrMarkup"
                                                          }
                                                        },
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.unitPrice"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "quantity": {
                                                      "$from-context": {
                                                        "path": "$data.0.quantity"
                                                      }
                                                    },
                                                    "comment": {
                                                      "$from-context": {
                                                        "path": "$data.0.bookingComment"
                                                      }
                                                    }
                                                  },
                                                  "path": ""
                                                }
                                              }
                                            }
                                          },
                                          "else": {}
                                        }
                                      }
                                    ]
                                  }
                                }
                              }
                            },
                            "data": {
                              "$array-map": {
                                "array": {
                                  "$from-context": {
                                    "path": "$mainEstimate"
                                  }
                                },
                                "map": {
                                  "$waterfall": {
                                    "arrayFunctions": [
                                      {
                                        "$if": {
                                          "condition": {
                                            "$not-empty": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$data.installationDates"
                                                }
                                              }
                                            }
                                          },
                                          "then": {
                                            "$array-map": {
                                              "array": {
                                                "$from-context": {
                                                  "path": "$data.installationDates"
                                                }
                                              },
                                              "map": {
                                                "$assign-object": {
                                                  "object": {},
                                                  "data": {
                                                    "date": {
                                                      "$from-context": {
                                                        "path": "$data.1.startTime"
                                                      }
                                                    },
                                                    "periodDay": {
                                                      "$date-format": {
                                                        "template": "DD.MM.YYYY",
                                                        "nameZone": "ETC/GMT+0",
                                                        "value": {
                                                          "$date-add": {
                                                            "date": {
                                                              "$from-context": {
                                                                "path": "$data.1.startTime"
                                                              }
                                                            },
                                                            "number": 3,
                                                            "interval": "h"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "time": {
                                                      "$replace": {
                                                        "template": "{{0}} - {{1}}",
                                                        "data": [
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.startTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          },
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.endTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          }
                                                        ]
                                                      }
                                                    },
                                                    "room": {
                                                      "$from-context": {
                                                        "path": "$data.0.name"
                                                      }
                                                    },
                                                    "floor": {
                                                      "$if": {
                                                        "condition": {
                                                          "===": {
                                                            "operand1": {
                                                              "$from-context": {
                                                                "path": "$data.0.rooms.0.room.floor"
                                                              }
                                                            },
                                                            "operand2": "open_area"
                                                          }
                                                        },
                                                        "then": "Открытая выставочная площадь",
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.rooms.0.room.floor"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "period": "Монтаж",
                                                    "typeService": "Аренда помещения",
                                                    "service": "Аренда",
                                                    "unitPrice": {
                                                      "$if": {
                                                        "condition": {
                                                          "$not-empty": {
                                                            "data": {
                                                              "$from-context": {
                                                                "path": "$data.0.allPriceMeterWithDiscountOrMarkup"
                                                              }
                                                            }
                                                          }
                                                        },
                                                        "then": {
                                                          "$from-context": {
                                                            "path": "$data.0.allPriceMeterWithDiscountOrMarkup"
                                                          }
                                                        },
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.allPriceMeter"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "quantity": {
                                                      "$from-context": {
                                                        "path": "$data.0.allSquare"
                                                      }
                                                    },
                                                    "comment": {
                                                      "$from-context": {
                                                        "path": "$data.0.comment"
                                                      }
                                                    }
                                                  },
                                                  "path": ""
                                                }
                                              }
                                            }
                                          },
                                          "else": {}
                                        }
                                      },
                                      {
                                        "$array-map": {
                                          "array": {
                                            "$from-context": {
                                              "path": "$data.eventDates"
                                            }
                                          },
                                          "map": {
                                            "$assign-object": {
                                              "object": {},
                                              "data": {
                                                "date": {
                                                  "$from-context": {
                                                    "path": "$data.1.startTime"
                                                  }
                                                },
                                                "periodDay": {
                                                  "$date-format": {
                                                    "template": "DD.MM.YYYY",
                                                    "nameZone": "ETC/GMT+0",
                                                    "value": {
                                                      "$date-add": {
                                                        "date": {
                                                          "$from-context": {
                                                            "path": "$data.1.startTime"
                                                          }
                                                        },
                                                        "number": 3,
                                                        "interval": "h"
                                                      }
                                                    }
                                                  }
                                                },
                                                "time": {
                                                  "$replace": {
                                                    "template": "{{0}} - {{1}}",
                                                    "data": [
                                                      {
                                                        "$date-format": {
                                                          "template": "HH:mm",
                                                          "nameZone": "ETC/GMT+0",
                                                          "value": {
                                                            "$date-add": {
                                                              "date": {
                                                                "$from-context": {
                                                                  "path": "$data.1.startTime"
                                                                }
                                                              },
                                                              "number": 3,
                                                              "interval": "h"
                                                            }
                                                          }
                                                        }
                                                      },
                                                      {
                                                        "$date-format": {
                                                          "template": "HH:mm",
                                                          "nameZone": "ETC/GMT+0",
                                                          "value": {
                                                            "$date-add": {
                                                              "date": {
                                                                "$from-context": {
                                                                  "path": "$data.1.endTime"
                                                                }
                                                              },
                                                              "number": 3,
                                                              "interval": "h"
                                                            }
                                                          }
                                                        }
                                                      }
                                                    ]
                                                  }
                                                },
                                                "room": {
                                                  "$from-context": {
                                                    "path": "$data.0.name"
                                                  }
                                                },
                                                "floor": {
                                                  "$if": {
                                                    "condition": {
                                                      "===": {
                                                        "operand1": {
                                                          "$from-context": {
                                                            "path": "$data.0.rooms.0.room.floor"
                                                          }
                                                        },
                                                        "operand2": "open_area"
                                                      }
                                                    },
                                                    "then": "Открытая выставочная площадь",
                                                    "else": {
                                                      "$from-context": {
                                                        "path": "$data.0.rooms.0.room.floor"
                                                      }
                                                    }
                                                  }
                                                },
                                                "period": "Мероприятие",
                                                "typeService": "Аренда помещения",
                                                "service": "Аренда",
                                                "unitPrice": {
                                                  "$if": {
                                                    "condition": {
                                                      "$not-empty": {
                                                        "data": {
                                                          "$from-context": {
                                                            "path": "$data.0.allPriceMeterWithDiscountOrMarkup"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "then": {
                                                      "$from-context": {
                                                        "path": "$data.0.allPriceMeterWithDiscountOrMarkup"
                                                      }
                                                    },
                                                    "else": {
                                                      "$from-context": {
                                                        "path": "$data.0.allPriceMeter"
                                                      }
                                                    }
                                                  }
                                                },
                                                "quantity": {
                                                  "$from-context": {
                                                    "path": "$data.0.allSquare"
                                                  }
                                                },
                                                "comment": {
                                                  "$from-context": {
                                                    "path": "$data.0.comment"
                                                  }
                                                }
                                              },
                                              "path": ""
                                            }
                                          }
                                        }
                                      },
                                      {
                                        "$if": {
                                          "condition": {
                                            "$not-empty": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$data.deinstallationDates"
                                                }
                                              }
                                            }
                                          },
                                          "then": {
                                            "$array-map": {
                                              "array": {
                                                "$from-context": {
                                                  "path": "$data.deinstallationDates"
                                                }
                                              },
                                              "map": {
                                                "$assign-object": {
                                                  "object": {},
                                                  "data": {
                                                    "date": {
                                                      "$from-context": {
                                                        "path": "$data.1.startTime"
                                                      }
                                                    },
                                                    "periodDay": {
                                                      "$date-format": {
                                                        "template": "DD.MM.YYYY",
                                                        "nameZone": "ETC/GMT+0",
                                                        "value": {
                                                          "$date-add": {
                                                            "date": {
                                                              "$from-context": {
                                                                "path": "$data.1.startTime"
                                                              }
                                                            },
                                                            "number": 3,
                                                            "interval": "h"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "time": {
                                                      "$replace": {
                                                        "template": "{{0}} - {{1}}",
                                                        "data": [
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.startTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          },
                                                          {
                                                            "$date-format": {
                                                              "template": "HH:mm",
                                                              "nameZone": "ETC/GMT+0",
                                                              "value": {
                                                                "$date-add": {
                                                                  "date": {
                                                                    "$from-context": {
                                                                      "path": "$data.1.endTime"
                                                                    }
                                                                  },
                                                                  "number": 3,
                                                                  "interval": "h"
                                                                }
                                                              }
                                                            }
                                                          }
                                                        ]
                                                      }
                                                    },
                                                    "room": {
                                                      "$from-context": {
                                                        "path": "$data.0.name"
                                                      }
                                                    },
                                                    "floor": {
                                                      "$if": {
                                                        "condition": {
                                                          "===": {
                                                            "operand1": {
                                                              "$from-context": {
                                                                "path": "$data.0.rooms.0.room.floor"
                                                              }
                                                            },
                                                            "operand2": "open_area"
                                                          }
                                                        },
                                                        "then": "Открытая выставочная площадь",
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.rooms.0.room.floor"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "period": "Демонтаж",
                                                    "typeService": "Аренда помещения",
                                                    "service": "Аренда",
                                                    "unitPrice": {
                                                      "$if": {
                                                        "condition": {
                                                          "$not-empty": {
                                                            "data": {
                                                              "$from-context": {
                                                                "path": "$data.0.allPriceMeterWithDiscountOrMarkup"
                                                              }
                                                            }
                                                          }
                                                        },
                                                        "then": {
                                                          "$from-context": {
                                                            "path": "$data.0.allPriceMeterWithDiscountOrMarkup"
                                                          }
                                                        },
                                                        "else": {
                                                          "$from-context": {
                                                            "path": "$data.0.allPriceMeter"
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "quantity": {
                                                      "$from-context": {
                                                        "path": "$data.0.allSquare"
                                                      }
                                                    },
                                                    "comment": {
                                                      "$from-context": {
                                                        "path": "$data.0.comment"
                                                      }
                                                    }
                                                  },
                                                  "path": ""
                                                }
                                              }
                                            }
                                          },
                                          "else": {}
                                        }
                                      }
                                    ]
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "filter": {
                    "$and": {
                      "operands": [
                        {
                          "$not-empty": {
                            "data": {
                              "$from-context": {
                                "path": "$data"
                              }
                            }
                          }
                        },
                        {
                          "$not-empty": {
                            "data": {
                              "$from-context": {
                                "path": "$data.typeService"
                              }
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              }
            }
          },
          {
            "$assign-context": {
              "path": "$tableEstimate",
              "data": {
                "$apply-func": {
                  "func": "  let all = data.sort(function(a, b) { const dateA = new Date(a.date);   const dateB = new Date(b.date);  return  dateA - dateB; });  return all",
                  "args": {
                    "data": {
                      "$apply-func": {
                        "func": "  return data.sort(function(a, b) {var x = a['typeService']; var y = b['typeService'];  return ((x < y) ? -1 : ((x > y) ? 1 : 0));                                                });",
                        "args": {
                          "data": {
                            "$from-context": {
                              "path": "$tableEstimate"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$assign-context": {
              "path": "$additionalFacilities",
              "data": {
                "$array-map": {
                  "array": {
                    "$api-data-query": {
                      "query": "additional_facilities/get_for_estimate_additional_facilities",
                      "variables": {
                        "eventId": {
                          "$from-context": {
                            "path": "objectId"
                          }
                        }
                      },
                      "responsePath": "items"
                    }
                  },
                  "map": {
                    "$assign-object": {
                      "path": "",
                      "object": {
                        "$from-context": {
                          "path": "$data"
                        }
                      },
                      "data": {
                        "typeService": {
                          "$from-context": {
                            "path": "$data.additionalService.servicesType.name"
                          }
                        },
                        "service": {
                          "$from-context": {
                            "path": "$data.additionalService.name"
                          }
                        },
                        "unitPrice": {
                          "$if": {
                            "condition": {
                              "$not-empty": {
                                "data": {
                                  "$from-context": {
                                    "path": "$data.unitPriceWithDiscountOrMarkup"
                                  }
                                }
                              }
                            },
                            "then": {
                              "$from-context": {
                                "path": "$data.unitPriceWithDiscountOrMarkup"
                              }
                            },
                            "else": {
                              "$from-context": {
                                "path": "$data.unitPrice"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$assign-response": {
              "data": {
                "$export-report": {
                  "sync": true,
                  "responseType": "content",
                  "timeout": "1200000",
                  "throwable": true,
                  "type": "xlsx",
                  "options": {
                    "templatePath": "files/templates/templates_estimate.xlsx"
                  },
                  "documentName": {
                    "$replace": {
                      "template": "Смета по мероприятию {{eventName}} от {{createdAt}}",
                      "data": {
                        "eventName": {
                          "$from-context": {
                            "path": "$estimate.name"
                          }
                        },
                        "createdAt": {
                          "$date-format": {
                            "template": "DD.MM.YYYY",
                            "nameZone": "ETC/GMT+0",
                            "value": {
                              "$date-add": {
                                "date": {
                                  "$datetime-now": {}
                                },
                                "number": 3,
                                "interval": "h"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "data": {
                    "event": {
                      "$from-context": {
                        "path": "$estimate"
                      }
                    },
                    "totalCost": {
                      "$from-context": {
                        "path": "$estimate.totalEventCostWithDiscountOrMarkup"
                      }
                    },
                    "createdAt": {
                      "$date-format": {
                        "template": "DD.MM.YYYY HH:mm",
                        "nameZone": "ETC/GMT+0",
                        "value": {
                          "$date-add": {
                            "date": {
                              "$datetime-now": {}
                            },
                            "number": 3,
                            "interval": "h"
                          }
                        }
                      }
                    },
                    "installationView": {
                      "$if": {
                        "condition": {
                          "$and": {
                            "operands": [
                              {
                                "$not-empty": {
                                  "data": {
                                    "$from-context": {
                                      "path": "$estimate.installationStart"
                                    }
                                  }
                                }
                              },
                              {
                                "$not-empty": {
                                  "data": {
                                    "$from-context": {
                                      "path": "$estimate.installationEnd"
                                    }
                                  }
                                }
                              }
                            ]
                          }
                        },
                        "then": {
                          "$if": {
                            "condition": {
                              "===": {
                                "operand1": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.installationStart"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                },
                                "operand2": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.installationEnd"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            "then": {
                              "$date-format": {
                                "template": "DD.MM.YYYY",
                                "nameZone": "ETC/GMT+0",
                                "value": {
                                  "$date-add": {
                                    "date": {
                                      "$from-context": {
                                        "path": "$estimate.installationEnd"
                                      }
                                    },
                                    "number": 3,
                                    "interval": "h"
                                  }
                                }
                              }
                            },
                            "else": {
                              "$replace": {
                                "template": "{{date1}} - {{date2}}",
                                "data": {
                                  "date1": {
                                    "$date-format": {
                                      "template": "DD.MM.YYYY",
                                      "nameZone": "ETC/GMT+0",
                                      "value": {
                                        "$date-add": {
                                          "date": {
                                            "$from-context": {
                                              "path": "$estimate.installationStart"
                                            }
                                          },
                                          "number": 3,
                                          "interval": "h"
                                        }
                                      }
                                    }
                                  },
                                  "date2": {
                                    "$date-format": {
                                      "template": "DD.MM.YYYY",
                                      "nameZone": "ETC/GMT+0",
                                      "value": {
                                        "$date-add": {
                                          "date": {
                                            "$from-context": {
                                              "path": "$estimate.installationEnd"
                                            }
                                          },
                                          "number": 3,
                                          "interval": "h"
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "else": {
                          "$if": {
                            "condition": {
                              "$and": {
                                "operands": [
                                  {
                                    "$empty": {
                                      "data": {
                                        "$from-context": {
                                          "path": "$estimate.installationStart"
                                        }
                                      }
                                    }
                                  },
                                  {
                                    "$empty": {
                                      "data": {
                                        "$from-context": {
                                          "path": "$estimate.installationEnd"
                                        }
                                      }
                                    }
                                  }
                                ]
                              }
                            },
                            "then": "-",
                            "else": {
                              "$if": {
                                "condition": {
                                  "$not-empty": {
                                    "data": {
                                      "$from-context": {
                                        "path": "$estimate.installationStart"
                                      }
                                    }
                                  }
                                },
                                "then": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.installationStart"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                },
                                "else": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.installationEnd"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "eventView": {
                      "$if": {
                        "condition": {
                          "===": {
                            "operand1": {
                              "$date-format": {
                                "template": "DD.MM.YYYY",
                                "nameZone": "ETC/GMT+0",
                                "value": {
                                  "$date-add": {
                                    "date": {
                                      "$from-context": {
                                        "path": "$estimate.eventStart"
                                      }
                                    },
                                    "number": 3,
                                    "interval": "h"
                                  }
                                }
                              }
                            },
                            "operand2": {
                              "$date-format": {
                                "template": "DD.MM.YYYY",
                                "nameZone": "ETC/GMT+0",
                                "value": {
                                  "$date-add": {
                                    "date": {
                                      "$from-context": {
                                        "path": "$estimate.eventEnd"
                                      }
                                    },
                                    "number": 3,
                                    "interval": "h"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "then": {
                          "$date-format": {
                            "template": "DD.MM.YYYY",
                            "nameZone": "ETC/GMT+0",
                            "value": {
                              "$date-add": {
                                "date": {
                                  "$from-context": {
                                    "path": "$estimate.eventEnd"
                                  }
                                },
                                "number": 3,
                                "interval": "h"
                              }
                            }
                          }
                        },
                        "else": {
                          "$replace": {
                            "template": "{{date1}} - {{date2}}",
                            "data": {
                              "date1": {
                                "$date-format": {
                                  "template": "DD.MM.YYYY",
                                  "nameZone": "ETC/GMT+0",
                                  "value": {
                                    "$date-add": {
                                      "date": {
                                        "$from-context": {
                                          "path": "$estimate.eventStart"
                                        }
                                      },
                                      "number": 3,
                                      "interval": "h"
                                    }
                                  }
                                }
                              },
                              "date2": {
                                "$date-format": {
                                  "template": "DD.MM.YYYY",
                                  "nameZone": "ETC/GMT+0",
                                  "value": {
                                    "$date-add": {
                                      "date": {
                                        "$from-context": {
                                          "path": "$estimate.eventEnd"
                                        }
                                      },
                                      "number": 3,
                                      "interval": "h"
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "deinstallationView": {
                      "$if": {
                        "condition": {
                          "$and": {
                            "operands": [
                              {
                                "$not-empty": {
                                  "data": {
                                    "$from-context": {
                                      "path": "$estimate.deinstallationStart"
                                    }
                                  }
                                }
                              },
                              {
                                "$not-empty": {
                                  "data": {
                                    "$from-context": {
                                      "path": "$estimate.deinstallationEnd"
                                    }
                                  }
                                }
                              }
                            ]
                          }
                        },
                        "then": {
                          "$if": {
                            "condition": {
                              "===": {
                                "operand1": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.deinstallationStart"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                },
                                "operand2": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.deinstallationEnd"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            "then": {
                              "$date-format": {
                                "template": "DD.MM.YYYY",
                                "nameZone": "ETC/GMT+0",
                                "value": {
                                  "$date-add": {
                                    "date": {
                                      "$from-context": {
                                        "path": "$estimate.deinstallationEnd"
                                      }
                                    },
                                    "number": 3,
                                    "interval": "h"
                                  }
                                }
                              }
                            },
                            "else": {
                              "$replace": {
                                "template": "{{date1}} - {{date2}}",
                                "data": {
                                  "date1": {
                                    "$date-format": {
                                      "template": "DD.MM.YYYY",
                                      "nameZone": "ETC/GMT+0",
                                      "value": {
                                        "$date-add": {
                                          "date": {
                                            "$from-context": {
                                              "path": "$estimate.deinstallationStart"
                                            }
                                          },
                                          "number": 3,
                                          "interval": "h"
                                        }
                                      }
                                    }
                                  },
                                  "date2": {
                                    "$date-format": {
                                      "template": "DD.MM.YYYY",
                                      "nameZone": "ETC/GMT+0",
                                      "value": {
                                        "$date-add": {
                                          "date": {
                                            "$from-context": {
                                              "path": "$estimate.deinstallationEnd"
                                            }
                                          },
                                          "number": 3,
                                          "interval": "h"
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "else": {
                          "$if": {
                            "condition": {
                              "$and": {
                                "operands": [
                                  {
                                    "$empty": {
                                      "data": {
                                        "$from-context": {
                                          "path": "$estimate.deinstallationStart"
                                        }
                                      }
                                    }
                                  },
                                  {
                                    "$empty": {
                                      "data": {
                                        "$from-context": {
                                          "path": "$estimate.deinstallationEnd"
                                        }
                                      }
                                    }
                                  }
                                ]
                              }
                            },
                            "then": "-",
                            "else": {
                              "$if": {
                                "condition": {
                                  "$not-empty": {
                                    "data": {
                                      "$from-context": {
                                        "path": "$estimate.deinstallationStart"
                                      }
                                    }
                                  }
                                },
                                "then": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.deinstallationStart"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                },
                                "else": {
                                  "$date-format": {
                                    "template": "DD.MM.YYYY",
                                    "nameZone": "ETC/GMT+0",
                                    "value": {
                                      "$date-add": {
                                        "date": {
                                          "$from-context": {
                                            "path": "$estimate.deinstallationEnd"
                                          }
                                        },
                                        "number": 3,
                                        "interval": "h"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "eventDate": {
                      "$replace": {
                        "template": "{{date1}} - {{date2}}",
                        "data": {
                          "date1": {
                            "$date-format": {
                              "template": "DD.MM.YYYY",
                              "nameZone": "ETC/GMT+0",
                              "value": {
                                "$date-add": {
                                  "date": {
                                    "$if": {
                                      "condition": {
                                        "$not-empty": {
                                          "data": {
                                            "$from-context": {
                                              "path": "$estimate.installationStart"
                                            }
                                          }
                                        }
                                      },
                                      "then": {
                                        "$from-context": {
                                          "path": "$estimate.installationStart"
                                        }
                                      },
                                      "else": {
                                        "$if": {
                                          "condition": {
                                            "$not-empty": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$estimate.installationEnd"
                                                }
                                              }
                                            }
                                          },
                                          "then": {
                                            "$from-context": {
                                              "path": "$estimate.installationEnd"
                                            }
                                          },
                                          "else": {
                                            "$from-context": {
                                              "path": "$estimate.eventStart"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "number": 3,
                                  "interval": "h"
                                }
                              }
                            }
                          },
                          "date2": {
                            "$date-format": {
                              "template": "DD.MM.YYYY",
                              "nameZone": "ETC/GMT+0",
                              "value": {
                                "$date-add": {
                                  "date": {
                                    "$if": {
                                      "condition": {
                                        "$not-empty": {
                                          "data": {
                                            "$from-context": {
                                              "path": "$estimate.deinstallationEnd"
                                            }
                                          }
                                        }
                                      },
                                      "then": {
                                        "$from-context": {
                                          "path": "$estimate.deinstallationEnd"
                                        }
                                      },
                                      "else": {
                                        "$if": {
                                          "condition": {
                                            "$not-empty": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$estimate.deinstallationStart"
                                                }
                                              }
                                            }
                                          },
                                          "then": {
                                            "$from-context": {
                                              "path": "$estimate.deinstallationStart"
                                            }
                                          },
                                          "else": {
                                            "$from-context": {
                                              "path": "$estimate.eventEnd"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "number": 3,
                                  "interval": "h"
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "partner": {
                      "$array-join": {
                        "array": {
                          "$array-pluck": {
                            "array": {
                              "$from-context": {
                                "path": "$estimate.organizers"
                              }
                            },
                            "key": "partner.name"
                          }
                        },
                        "separator": ", "
                      }
                    },
                    "contactPerson": {
                      "$array-join": {
                        "array": {
                          "$array-pluck": {
                            "array": {
                              "$from-context": {
                                "path": "$estimate.organizers"
                              }
                            },
                            "key": "partner.mainContactPerson.fullName"
                          }
                        },
                        "separator": ", "
                      }
                    },
                    "contactPersonPhone": {
                      "$array-join": {
                        "array": {
                          "$array-pluck": {
                            "array": {
                              "$from-context": {
                                "path": "$estimate.organizers"
                              }
                            },
                            "key": "partner.mainContactPerson.phone"
                          }
                        },
                        "separator": ", "
                      }
                    },
                    "curator": {
                      "$array-join": {
                        "array": {
                          "$array-pluck": {
                            "array": {
                              "$from-context": {
                                "path": "$estimate.curators"
                              }
                            },
                            "key": "user.fullName"
                          }
                        },
                        "separator": ", "
                      }
                    },
                    "curatorPhone": {
                      "$array-join": {
                        "array": {
                          "$array-pluck": {
                            "array": {
                              "$from-context": {
                                "path": "$estimate.curators"
                              }
                            },
                            "key": "user.phoneView"
                          }
                        },
                        "separator": ", "
                      }
                    },
                    "tableEstimate": {
                      "$from-context": {
                        "path": "$tableEstimate"
                      }
                    },
                    "additionalFacilities": {
                      "$from-context": {
                        "path": "$additionalFacilities"
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Формирование сметы",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ]
      },
      "calendar": {
        "title": "Просмотреть календарь мероприятий",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Просмотреть календарь мероприятий"
          }
        },
        "views": {
          "gui": {
            "path": "event/calendar",
            "mode": "form",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "event/calendar",
            "event/get_new"
          ]
        }
      },
      "edit_part": {
        "title": "При редактировании необходимо согласование только в случае применения скидок/наценок",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "При редактировании необходимо согласование только в случае применения скидок/наценок"
          }
        },
        "views": {},
        "functions": []
      }
    },
    "statesActions": {
      "add": {
        "title": "Добавить",
        "description": "Псевдо-добавление мероприятия",
        "grants": {
          "rbac": {
            "enabled": true,
            "permissionCode": "event.create"
          }
        },
        "views": {
          "gui": {
            "path": "event/add",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "event_type/get_for_dropdown",
            "industry/get_for_dropdown",
            "partner/get_for_select",
            "user/get_for_select",
            "additional_service/get_for_select",
            "additional_facilities/list",
            "room/list_for_select",
            "room_type/get_for_dropdown",
            "booking/list",
            "event/get_total_cost"
          ]
        },
        "functions": [
          {
            "$assign-context": {
              "path": "$eventData",
              "data": {
                "$merge": {
                  "data": [
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '' || obj[key] === null) && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.commonInfo"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '' || obj[key] === null) && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.workingHours"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "result = {organizers: [], curators: []}; organizers.forEach((organizer) => {result.organizers.push({ organizerId: organizer.organizerId });}); curators.forEach((curator) => {result.curators.push({ userId: curator.userId });}); return result;",
                        "args": {
                          "organizers": {
                            "$from-context": {
                              "path": "data.organizers"
                            }
                          },
                          "curators": {
                            "$from-context": {
                              "path": "data.curators"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "$ref:js:prepare-event-files",
                        "args": {
                          "data": {
                            "$from-context": {
                              "path": "data.attachments"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "$assign-context": {
              "path": "$state",
              "data": {
                "$api-data-query": {
                  "query": "event/get_state",
                  "variables": {
                    "id": {
                      "$from-context": {
                        "path": "objectId"
                      }
                    }
                  },
                  "responsePath": "object.state"
                }
              }
            }
          },
          {
            "$api-data-query": {
              "query": "additional_facilities/get_filled",
              "variables": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "",
              "resultPath": "$facilities"
            }
          },
          {
            "$api-data-query": {
              "query": "booking/get_filled",
              "variables": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "",
              "resultPath": "$bookings"
            }
          },
          {
            "$assign-object": {
              "path": "number",
              "data": {
                "$sum": {
                  "terms": [
                    1,
                    {
                      "$api-data-query": {
                        "query": "event/get_actual",
                        "responsePath": "pagination.count"
                      }
                    }
                  ]
                }
              },
              "object": {
                "$from-context": {
                  "path": "$eventData"
                }
              }
            }
          },
          {
            "$if": {
              "condition": {
                "$and": {
                  "operands": [
                    {
                      "===": {
                        "operand1": "no",
                        "operand2": {
                          "$from-context": {
                            "path": "data.commonInfo.discountOrMarkupFlag"
                          }
                        }
                      }
                    },
                    {
                      "$empty": {
                        "data": {
                          "$from-context": {
                            "path": "$bookings.withDiscountOrMarkup"
                          }
                        }
                      }
                    },
                    {
                      "$empty": {
                        "data": {
                          "$from-context": {
                            "path": "$facilities.withDiscountOrMarkupServices"
                          }
                        }
                      }
                    },
                    {
                      "$empty": {
                        "data": {
                          "$from-context": {
                            "path": "$facilities.withDiscountOrMarkupFacilities"
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "then": {
                "$api-data-query": {
                  "query": "event/update_by_id",
                  "variables": {
                    "$assign-object": {
                      "path": "data",
                      "data": {
                        "$from-context": {
                          "path": "$eventData"
                        }
                      },
                      "object": {
                        "id": {
                          "$from-context": {
                            "path": "objectId"
                          }
                        }
                      }
                    }
                  },
                  "responsePath": "object"
                }
              },
              "else": {
                "$if": {
                  "condition": {
                    "$from-context": {
                      "path": "data.hasRequestAcceptPermission"
                    }
                  },
                  "then": {
                    "$api-data-query": {
                      "query": "event/update_by_id",
                      "variables": {
                        "$assign-object": {
                          "path": "data",
                          "data": {
                            "$from-context": {
                              "path": "$eventData"
                            }
                          },
                          "object": {
                            "id": {
                              "$from-context": {
                                "path": "objectId"
                              }
                            }
                          }
                        }
                      },
                      "responsePath": "object"
                    }
                  },
                  "else": {
                    "$waterfall": {
                      "arrayFunctions": [
                        {
                          "$api-data-query": {
                            "query": "event/update_by_id",
                            "variables": {
                              "$assign-object": {
                                "path": "data",
                                "data": {
                                  "$from-context": {
                                    "path": "$eventData"
                                  }
                                },
                                "object": {
                                  "id": {
                                    "$from-context": {
                                      "path": "objectId"
                                    }
                                  }
                                }
                              }
                            },
                            "responsePath": "object"
                          }
                        },
                        {
                          "$workflow-run": {
                            "workflowName": "event",
                            "action": "add_copy",
                            "data": {
                              "initialEventId": {
                                "$from-context": {
                                  "path": "objectId"
                                }
                              },
                              "requestCode": "edit_cost",
                              "state": {
                                "$from-context": {
                                  "path": "$state"
                                }
                              },
                              "eventData": {
                                "$assign-object": {
                                  "path": "",
                                  "data": {
                                    "createdBy": {
                                      "$active-user": {
                                        "field": "_id"
                                      }
                                    },
                                    "discountOrMarkupFlag": "no",
                                    "discountOrMarkup": 0,
                                    "totalEventCostWithDiscountOrMarkup": {
                                      "$from-context": {
                                        "path": "$eventData.totalEventCost"
                                      }
                                    }
                                  },
                                  "object": {
                                    "$from-context": {
                                      "path": "$eventData"
                                    }
                                  }
                                }
                              },
                              "bookings": {
                                "$merge": {
                                  "data": [
                                    {
                                      "$from-context": {
                                        "path": "$bookings.withDiscountOrMarkup"
                                      }
                                    },
                                    {
                                      "$from-context": {
                                        "path": "$bookings.noDiscountOrMarkup"
                                      }
                                    }
                                  ]
                                }
                              },
                              "services": {
                                "$merge": {
                                  "data": [
                                    {
                                      "$from-context": {
                                        "path": "$facilities.withDiscountOrMarkupServices"
                                      }
                                    },
                                    {
                                      "$from-context": {
                                        "path": "$facilities.noDiscountOrMarkupServices"
                                      }
                                    }
                                  ]
                                }
                              }
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              }
            }
          }
        ],
        "results": {
          "conditional": [
            {
              "conditions": {
                "$from-context": {
                  "path": "$eventData.preliminary"
                }
              },
              "state": "pre_booking"
            },
            {
              "conditions": {
                "$not": {
                  "data": {
                    "$from-context": {
                      "path": "$eventData.preliminary"
                    }
                  }
                }
              },
              "state": "requested"
            }
          ]
        }
      },
      "view": {
        "title": "Просмотреть",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Просмотреть карточку мероприятия"
          }
        },
        "views": {
          "gui": {
            "path": "event/view",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "event/get_event_history",
            "event/get_request_id",
            "additional_facilities/list",
            "booking/list",
            "booking/get_for_view_history",
            "additional_facilities/get_for_view_history"
          ]
        }
      },
      "view-in-calendar": {
        "title": "Просмотреть",
        "grants": {
          "rbac": {
            "enabled": true,
            "permissionCode": "event.calendar"
          },
          "includeInActionsList": {
            "availableForViews": "notForAny",
            "views": []
          }
        },
        "views": {
          "gui": {
            "path": "event/view_in_calendar",
            "mode": "popup",
            "layout": "cabinet"
          },
          "availableQueriesInViews": []
        }
      },
      "launch-export": {
        "title": "Сформировать смету",
        "description": "Открыть модальное окно формирования сметы",
        "grants": {
          "rbac": {
            "enabled": true,
            "permissionCode": "event.export-estimate"
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/launch-export",
            "mode": "popup",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "event/get_name"
          ]
        }
      },
      "edit": {
        "title": "Редактировать",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Редактировать мероприятие"
          }
        },
        "views": {
          "gui": {
            "path": "event/edit",
            "layout": "cabinet"
          },
          "availableQueriesInViews": [
            "event_type/get_for_dropdown",
            "industry/get_for_dropdown",
            "partner/get_for_select",
            "user/get_for_select",
            "additional_service/get_for_select",
            "additional_facilities/list_not_filled_for_event",
            "additional_facilities/get_for_select_in_event",
            "additional_service/get_name_for_select",
            "additional_facilities/list",
            "booking/list",
            "room/get_name",
            "event/get_total_cost",
            "room/list_for_select",
            "room_type/get_for_dropdown"
          ]
        },
        "functions": [
          {
            "$assign-context": {
              "path": "$eventData",
              "data": {
                "$merge": {
                  "data": [
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '') && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.commonInfo"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '') && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.workingHours"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "result = {organizers: [], curators: []}; organizers.forEach((organizer) => {result.organizers.push({ organizerId: organizer.organizerId });}); curators.forEach((curator) => {result.curators.push({ userId: curator.userId });}); return result;",
                        "args": {
                          "organizers": {
                            "$from-context": {
                              "path": "data.organizers"
                            }
                          },
                          "curators": {
                            "$from-context": {
                              "path": "data.curators"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "$ref:js:prepare-event-files",
                        "args": {
                          "data": {
                            "$from-context": {
                              "path": "data.attachments"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "$assign-context": {
              "path": "$state",
              "data": {
                "$api-data-query": {
                  "query": "event/get_state",
                  "variables": {
                    "id": {
                      "$from-context": {
                        "path": "objectId"
                      }
                    }
                  },
                  "responsePath": "object.state"
                }
              }
            }
          },
          {
            "$assign-object": {
              "path": "number",
              "data": {
                "$if": {
                  "condition": {
                    "===": {
                      "operand1": "draft",
                      "operand2": {
                        "$from-context": {
                          "path": "$state"
                        }
                      }
                    }
                  },
                  "then": {
                    "$sum": {
                      "terms": [
                        1,
                        {
                          "$api-data-query": {
                            "query": "event/get_actual",
                            "responsePath": "pagination.count"
                          }
                        }
                      ]
                    }
                  },
                  "else": {
                    "$api-data-query": {
                      "query": "event/get_number",
                      "variables": {
                        "id": {
                          "$from-context": {
                            "path": "objectId"
                          }
                        }
                      },
                      "responsePath": "object.number"
                    }
                  }
                }
              },
              "object": {
                "$from-context": {
                  "path": "$eventData"
                }
              }
            }
          },
          {
            "$if": {
              "condition": {
                "===": {
                  "operand1": "accept_request",
                  "operand2": {
                    "$from-context": {
                      "path": "data.hasPermission"
                    }
                  }
                }
              },
              "then": {
                "$waterfall": {
                  "arrayFunctions": [
                    {
                      "$api-data-query": {
                        "query": "event/update_by_id",
                        "variables": {
                          "$assign-object": {
                            "path": "data",
                            "data": {
                              "$from-context": {
                                "path": "$eventData"
                              }
                            },
                            "object": {
                              "id": {
                                "$from-context": {
                                  "path": "objectId"
                                }
                              }
                            }
                          }
                        },
                        "responsePath": "object"
                      }
                    },
                    {
                      "$api-data-query": {
                        "query": "event/update",
                        "variables": {
                          "$assign-object": {
                            "path": "data",
                            "data": {
                              "documents": {
                                "fileLogo": {
                                  "$if": {
                                    "condition": {
                                      "$empty": {
                                        "data": {
                                          "$from-context": {
                                            "path": "$eventData.documents.fileLogo"
                                          }
                                        }
                                      }
                                    },
                                    "then": null
                                  }
                                },
                                "fileCostings": {
                                  "$if": {
                                    "condition": {
                                      "$empty": {
                                        "data": {
                                          "$from-context": {
                                            "path": "$eventData.documents.fileCostings"
                                          }
                                        }
                                      }
                                    },
                                    "then": null
                                  }
                                },
                                "fileListOfExhibitors": {
                                  "$if": {
                                    "condition": {
                                      "$empty": {
                                        "data": {
                                          "$from-context": {
                                            "path": "$eventData.documents.fileListOfExhibitors"
                                          }
                                        }
                                      }
                                    },
                                    "then": null
                                  }
                                },
                                "filePresidentProgram": {
                                  "$if": {
                                    "condition": {
                                      "$empty": {
                                        "data": {
                                          "$from-context": {
                                            "path": "$eventData.documents.filePresidentProgram"
                                          }
                                        }
                                      }
                                    },
                                    "then": null
                                  }
                                }
                              }
                            },
                            "object": {
                              "id": {
                                "$from-context": {
                                  "path": "objectId"
                                }
                              }
                            }
                          }
                        },
                        "responsePath": "object"
                      }
                    }
                  ]
                }
              },
              "else": {
                "$if": {
                  "condition": {
                    "$and": {
                      "operands": [
                        {
                          "!==": {
                            "operand1": {
                              "$from-context": {
                                "path": "$state"
                              }
                            },
                            "operand2": "draft"
                          }
                        },
                        {
                          "!==": {
                            "operand1": {
                              "$from-context": {
                                "path": "$state"
                              }
                            },
                            "operand2": "pre_booking"
                          }
                        }
                      ]
                    }
                  },
                  "then": {
                    "$if": {
                      "condition": {
                        "===": {
                          "operand1": "edit_part",
                          "operand2": {
                            "$from-context": {
                              "path": "data.hasPermission"
                            }
                          }
                        }
                      },
                      "then": {
                        "$if": {
                          "condition": {
                            "===": {
                              "operand1": {
                                "$from-context": {
                                  "path": "data.commonInfo.discountOrMarkupFlag"
                                }
                              },
                              "operand2": "no"
                            }
                          },
                          "then": {
                            "$waterfall": {
                              "arrayFunctions": [
                                {
                                  "$api-data-query": {
                                    "query": "event/update_by_id",
                                    "variables": {
                                      "$assign-object": {
                                        "path": "data",
                                        "data": {
                                          "$from-context": {
                                            "path": "$eventData"
                                          }
                                        },
                                        "object": {
                                          "id": {
                                            "$from-context": {
                                              "path": "objectId"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                },
                                {
                                  "$api-data-query": {
                                    "query": "event/update",
                                    "variables": {
                                      "$assign-object": {
                                        "path": "data",
                                        "data": {
                                          "documents": {
                                            "fileLogo": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.fileLogo"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            },
                                            "fileCostings": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.fileCostings"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            },
                                            "fileListOfExhibitors": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.fileListOfExhibitors"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            },
                                            "filePresidentProgram": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.filePresidentProgram"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            }
                                          }
                                        },
                                        "object": {
                                          "id": {
                                            "$from-context": {
                                              "path": "objectId"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                }
                              ]
                            }
                          },
                          "else": {
                            "$waterfall": {
                              "arrayFunctions": [
                                {
                                  "$assign-context": {
                                    "path": "$eventRequestDataOld",
                                    "data": {
                                      "$api-data-query": {
                                        "query": "event_request_data/add",
                                        "variables": {
                                          "data": {
                                            "$assign-object": {
                                              "object": {
                                                "$api-data-query": {
                                                  "query": "event/get_for_old_request_data",
                                                  "variables": {
                                                    "id": {
                                                      "$from-context": {
                                                        "path": "objectId"
                                                      }
                                                    }
                                                  },
                                                  "responsePath": "object"
                                                }
                                              },
                                              "data": {
                                                "requestDataType": "old"
                                              },
                                              "path": ""
                                            }
                                          }
                                        },
                                        "responsePath": "object"
                                      }
                                    }
                                  }
                                },
                                {
                                  "$assign-context": {
                                    "path": "$eventRequestDataNew",
                                    "data": {
                                      "$api-data-query": {
                                        "query": "event_request_data/add",
                                        "variables": {
                                          "data": {
                                            "$assign-object": {
                                              "object": {
                                                "$exclude": {
                                                  "data": {
                                                    "$from-context": {
                                                      "path": "$eventData"
                                                    }
                                                  },
                                                  "exclude": [
                                                    "number"
                                                  ]
                                                }
                                              },
                                              "data": {
                                                "requestDataType": "new"
                                              },
                                              "path": ""
                                            }
                                          }
                                        },
                                        "responsePath": "object"
                                      }
                                    }
                                  }
                                },
                                {
                                  "$api-data-query": {
                                    "query": "event/update_by_id",
                                    "variables": {
                                      "$assign-object": {
                                        "path": "data",
                                        "data": {
                                          "$exclude": {
                                            "data": {
                                              "$from-context": {
                                                "path": "$eventData"
                                              }
                                            },
                                            "exclude": [
                                              "hasPermission",
                                              "discountOrMarkupFlag",
                                              "discountOrMarkup",
                                              "totalEventCostWithDiscountOrMarkup"
                                            ]
                                          }
                                        },
                                        "object": {
                                          "id": {
                                            "$from-context": {
                                              "path": "objectId"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                },
                                {
                                  "$api-data-query": {
                                    "query": "event/update",
                                    "variables": {
                                      "$assign-object": {
                                        "path": "data",
                                        "data": {
                                          "documents": {
                                            "fileLogo": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.fileLogo"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            },
                                            "fileCostings": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.fileCostings"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            },
                                            "fileListOfExhibitors": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.fileListOfExhibitors"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            },
                                            "filePresidentProgram": {
                                              "$if": {
                                                "condition": {
                                                  "$empty": {
                                                    "data": {
                                                      "$from-context": {
                                                        "path": "$eventData.documents.filePresidentProgram"
                                                      }
                                                    }
                                                  }
                                                },
                                                "then": null
                                              }
                                            }
                                          }
                                        },
                                        "object": {
                                          "id": {
                                            "$from-context": {
                                              "path": "objectId"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                },
                                {
                                  "$workflow-run": {
                                    "workflowName": "request",
                                    "action": "add",
                                    "data": {
                                      "$assign-object": {
                                        "path": "",
                                        "data": {
                                          "type": "edit_cost",
                                          "eventId": {
                                            "$from-context": {
                                              "path": "objectId"
                                            }
                                          },
                                          "oldDataEventId": {
                                            "$from-context": {
                                              "path": "$eventRequestDataOld.id"
                                            }
                                          },
                                          "changeEventId": {
                                            "$from-context": {
                                              "path": "$eventRequestDataNew.id"
                                            }
                                          },
                                          "creatorId": {
                                            "$active-user": {
                                              "field": "_id"
                                            }
                                          },
                                          "createDate": {
                                            "$datetime-now": {}
                                          }
                                        },
                                        "object": {}
                                      }
                                    }
                                  }
                                }
                              ]
                            }
                          }
                        }
                      },
                      "else": {
                        "$waterfall": {
                          "arrayFunctions": [
                            {
                              "$assign-context": {
                                "path": "$eventRequestDataOld",
                                "data": {
                                  "$api-data-query": {
                                    "query": "event_request_data/add",
                                    "variables": {
                                      "data": {
                                        "$assign-object": {
                                          "object": {
                                            "$api-data-query": {
                                              "query": "event/get_for_old_request_data",
                                              "variables": {
                                                "id": {
                                                  "$from-context": {
                                                    "path": "objectId"
                                                  }
                                                }
                                              },
                                              "responsePath": "object"
                                            }
                                          },
                                          "data": {
                                            "requestDataType": "old"
                                          },
                                          "path": ""
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                }
                              }
                            },
                            {
                              "$assign-context": {
                                "path": "$eventRequestDataNew",
                                "data": {
                                  "$api-data-query": {
                                    "query": "event_request_data/add",
                                    "variables": {
                                      "data": {
                                        "$assign-object": {
                                          "object": {
                                            "$exclude": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$eventData"
                                                }
                                              },
                                              "exclude": [
                                                "number"
                                              ]
                                            }
                                          },
                                          "data": {
                                            "requestDataType": "new"
                                          },
                                          "path": ""
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                }
                              }
                            },
                            {
                              "$workflow-run": {
                                "workflowName": "request",
                                "action": "add",
                                "data": {
                                  "$assign-object": {
                                    "path": "",
                                    "data": {
                                      "type": "edit_event",
                                      "eventId": {
                                        "$from-context": {
                                          "path": "objectId"
                                        }
                                      },
                                      "oldDataEventId": {
                                        "$from-context": {
                                          "path": "$eventRequestDataOld.id"
                                        }
                                      },
                                      "changeEventId": {
                                        "$from-context": {
                                          "path": "$eventRequestDataNew.id"
                                        }
                                      },
                                      "creatorId": {
                                        "$active-user": {
                                          "field": "_id"
                                        }
                                      },
                                      "createDate": {
                                        "$datetime-now": {}
                                      }
                                    },
                                    "object": {}
                                  }
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  },
                  "else": {
                    "$if": {
                      "condition": {
                        "===": {
                          "operand1": {
                            "$from-context": {
                              "path": "data.commonInfo.discountOrMarkupFlag"
                            }
                          },
                          "operand2": "no"
                        }
                      },
                      "then": {
                        "$waterfall": {
                          "arrayFunctions": [
                            {
                              "$api-data-query": {
                                "query": "event/update_by_id",
                                "variables": {
                                  "$assign-object": {
                                    "path": "data",
                                    "data": {
                                      "$from-context": {
                                        "path": "$eventData"
                                      }
                                    },
                                    "object": {
                                      "id": {
                                        "$from-context": {
                                          "path": "objectId"
                                        }
                                      }
                                    }
                                  }
                                },
                                "responsePath": "object"
                              }
                            },
                            {
                              "$api-data-query": {
                                "query": "event/update",
                                "variables": {
                                  "$assign-object": {
                                    "path": "data",
                                    "data": {
                                      "documents": {
                                        "fileLogo": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.fileLogo"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        },
                                        "fileCostings": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.fileCostings"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        },
                                        "fileListOfExhibitors": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.fileListOfExhibitors"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        },
                                        "filePresidentProgram": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.filePresidentProgram"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        }
                                      }
                                    },
                                    "object": {
                                      "id": {
                                        "$from-context": {
                                          "path": "objectId"
                                        }
                                      }
                                    }
                                  }
                                },
                                "responsePath": "object"
                              }
                            }
                          ]
                        }
                      },
                      "else": {
                        "$waterfall": {
                          "arrayFunctions": [
                            {
                              "$assign-context": {
                                "path": "$eventRequestDataOld",
                                "data": {
                                  "$api-data-query": {
                                    "query": "event_request_data/add",
                                    "variables": {
                                      "data": {
                                        "$assign-object": {
                                          "object": {
                                            "$api-data-query": {
                                              "query": "event/get_for_old_request_data",
                                              "variables": {
                                                "id": {
                                                  "$from-context": {
                                                    "path": "objectId"
                                                  }
                                                }
                                              },
                                              "responsePath": "object"
                                            }
                                          },
                                          "data": {
                                            "requestDataType": "old"
                                          },
                                          "path": ""
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                }
                              }
                            },
                            {
                              "$assign-context": {
                                "path": "$eventRequestDataNew",
                                "data": {
                                  "$api-data-query": {
                                    "query": "event_request_data/add",
                                    "variables": {
                                      "data": {
                                        "$assign-object": {
                                          "object": {
                                            "$exclude": {
                                              "data": {
                                                "$from-context": {
                                                  "path": "$eventData"
                                                }
                                              },
                                              "exclude": [
                                                "number"
                                              ]
                                            }
                                          },
                                          "data": {
                                            "requestDataType": "new"
                                          },
                                          "path": ""
                                        }
                                      }
                                    },
                                    "responsePath": "object"
                                  }
                                }
                              }
                            },
                            {
                              "$assign-object": {
                                "path": "number",
                                "data": {
                                  "$sum": {
                                    "terms": [
                                      1,
                                      {
                                        "$api-data-query": {
                                          "query": "event/get_actual",
                                          "responsePath": "pagination.count"
                                        }
                                      }
                                    ]
                                  }
                                },
                                "object": {
                                  "$from-context": {
                                    "path": "$eventData"
                                  }
                                }
                              }
                            },
                            {
                              "$api-data-query": {
                                "query": "event/update_by_id",
                                "variables": {
                                  "$assign-object": {
                                    "path": "data",
                                    "data": {
                                      "$exclude": {
                                        "data": {
                                          "$from-context": {
                                            "path": "$eventData"
                                          }
                                        },
                                        "exclude": [
                                          "hasPermission",
                                          "discountOrMarkupFlag",
                                          "discountOrMarkup",
                                          "totalEventCostWithDiscountOrMarkup"
                                        ]
                                      }
                                    },
                                    "object": {
                                      "id": {
                                        "$from-context": {
                                          "path": "objectId"
                                        }
                                      }
                                    }
                                  }
                                },
                                "responsePath": "object"
                              }
                            },
                            {
                              "$api-data-query": {
                                "query": "event/update",
                                "variables": {
                                  "$assign-object": {
                                    "path": "data",
                                    "data": {
                                      "documents": {
                                        "fileLogo": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.fileLogo"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        },
                                        "fileCostings": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.fileCostings"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        },
                                        "fileListOfExhibitors": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.fileListOfExhibitors"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        },
                                        "filePresidentProgram": {
                                          "$if": {
                                            "condition": {
                                              "$empty": {
                                                "data": {
                                                  "$from-context": {
                                                    "path": "$eventData.documents.filePresidentProgram"
                                                  }
                                                }
                                              }
                                            },
                                            "then": null
                                          }
                                        }
                                      }
                                    },
                                    "object": {
                                      "id": {
                                        "$from-context": {
                                          "path": "objectId"
                                        }
                                      }
                                    }
                                  }
                                },
                                "responsePath": "object"
                              }
                            },
                            {
                              "$workflow-run": {
                                "workflowName": "request",
                                "action": "add",
                                "data": {
                                  "$assign-object": {
                                    "path": "",
                                    "data": {
                                      "type": "edit_cost",
                                      "eventId": {
                                        "$from-context": {
                                          "path": "objectId"
                                        }
                                      },
                                      "oldDataEventId": {
                                        "$from-context": {
                                          "path": "$eventRequestDataOld.id"
                                        }
                                      },
                                      "changeEventId": {
                                        "$from-context": {
                                          "path": "$eventRequestDataNew.id"
                                        }
                                      },
                                      "creatorId": {
                                        "$active-user": {
                                          "field": "_id"
                                        }
                                      },
                                      "createDate": {
                                        "$datetime-now": {}
                                      }
                                    },
                                    "object": {}
                                  }
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Редактирование мероприятия",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "conditional": [
            {
              "conditions": {
                "$from-context": {
                  "path": "$eventData.preliminary"
                }
              },
              "state": "pre_booking"
            },
            {
              "conditions": {
                "$and": {
                  "operands": [
                    {
                      "$not": {
                        "data": {
                          "$from-context": {
                            "path": "$eventData.preliminary"
                          }
                        }
                      }
                    },
                    {
                      "===": {
                        "operand1": "pre_booking",
                        "operand2": {
                          "$from-context": {
                            "path": "$state"
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "state": "requested"
            },
            {
              "conditions": {
                "$and": {
                  "operands": [
                    {
                      "$not": {
                        "data": {
                          "$from-context": {
                            "path": "$eventData.preliminary"
                          }
                        }
                      }
                    },
                    {
                      "===": {
                        "operand1": "draft",
                        "operand2": {
                          "$from-context": {
                            "path": "$state"
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "state": "requested"
            }
          ]
        }
      },
      "copy_event": {
        "title": "Копировать",
        "grants": {
          "rbac": {
            "enabled": true,
            "title": "Копировать мероприятие"
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/copy",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$workflow-run": {
              "workflowName": "event",
              "action": "copy",
              "data": {
                "id": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "creatorId": {
                  "$active-user": {
                    "field": "_id"
                  }
                }
              }
            }
          },
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Копирование мероприятия",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ]
      },
      "delete": {
        "title": "Удалить",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Удалить мероприятие"
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/delete",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$api-data-query": {
              "query": "event/get_request",
              "variables": {
                "id": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "items.0.requests",
              "resultPath": "$request_for_event"
            }
          },
          {
            "$workflow-run-from-collection": {
              "workflowName": "request",
              "action": "delete",
              "collection": {
                "$from-context": {
                  "path": "$request_for_event"
                }
              },
              "objectIdPath": "_id"
            }
          }
        ],
        "results": {
          "unconditional": "deleted"
        }
      },
      "cancel": {
        "title": "Отменить",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Отменить мероприятие"
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/cancel",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$if": {
              "condition": {
                "$from-context": {
                  "path": "data.hasPermission"
                }
              },
              "then": {
                "$waterfall": {
                  "arrayFunctions": [
                    {
                      "$api-data-query": {
                        "query": "event/update",
                        "id": {
                          "$from-context": {
                            "path": "objectId"
                          }
                        },
                        "variables": {
                          "data": {
                            "cancelReason": {
                              "$from-context": {
                                "path": "data.cancelReason"
                              }
                            }
                          },
                          "id": {
                            "$from-context": {
                              "path": "objectId"
                            }
                          }
                        },
                        "responsePath": "object"
                      }
                    },
                    {
                      "$api-data-query": {
                        "query": "request/get_for_event_cancel_or_delete",
                        "variables": {
                          "id": {
                            "$from-context": {
                              "path": "objectId"
                            }
                          }
                        },
                        "responsePath": "items",
                        "resultPath": "$requests"
                      }
                    },
                    {
                      "$workflow-run-from-collection": {
                        "workflowName": "request",
                        "action": "to_rejected",
                        "collection": {
                          "$from-context": {
                            "path": "$requests"
                          }
                        },
                        "objectIdPath": "id"
                      }
                    }
                  ]
                }
              },
              "else": {
                "$workflow-run": {
                  "workflowName": "request",
                  "action": "add",
                  "data": {
                    "$assign-object": {
                      "path": "",
                      "data": {
                        "type": "cancel",
                        "eventId": {
                          "$from-context": {
                            "path": "objectId"
                          }
                        },
                        "creatorId": {
                          "$active-user": {
                            "field": "_id"
                          }
                        },
                        "createDate": {
                          "$datetime-now": {}
                        },
                        "cancelReason": {
                          "$from-context": {
                            "path": "data.cancelReason"
                          }
                        }
                      },
                      "object": {}
                    }
                  }
                }
              }
            }
          },
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Отмена мероприятия",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "conditional": [
            {
              "conditions": {
                "$from-context": {
                  "path": "data.hasPermission"
                }
              },
              "state": "canceled"
            }
          ]
        }
      },
      "to_requested": {
        "title": "Добавить запрос",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Перевести мероприятие в статус \"Получен запрос\""
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/change_state",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$api-data-query": {
              "query": "event/update",
              "id": {
                "$from-context": {
                  "path": "objectId"
                }
              },
              "variables": {
                "data": {
                  "preliminary": false
                },
                "id": {
                  "$from-context": {
                    "path": "objectId"
                  }
                }
              },
              "responsePath": "object"
            }
          },
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Добавление запроса",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "requested"
        }
      },
      "to_task_received": {
        "title": "Добавить ТЗ",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Перевести мероприятие в статус \"Получено ТЗ\""
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/change_state",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Добавление ТЗ",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "task_received"
        }
      },
      "to_agreed": {
        "title": "Согласовать смету",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Перевести мероприятие в статус \"Согласована смета\""
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/change_state",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Согласование сметы",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "agreed"
        }
      },
      "to_check_in": {
        "title": "Провести check-in",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Перевести мероприятие в статус \"Пройден check-in\""
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/change_state",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Проведение check-in",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "check_in"
        }
      },
      "to_check_out": {
        "title": "Провести check-out",
        "grants": {
          "rbac": {
            "enabled": true,
            "visible": true,
            "title": "Перевести мероприятие в статус \"Пройден check-out\""
          },
          "includeInActionsList": {
            "availableForViews": "onlyFor",
            "views": [
              "event/list",
              "event/view"
            ]
          }
        },
        "views": {
          "gui": {
            "path": "event/change_state",
            "layout": "cabinet",
            "mode": "popup"
          }
        },
        "functions": [
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Проведение check-out",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "check_out"
        }
      },
      "to_canceled": {
        "title": "Перевести в статус \"Отменено\"",
        "grants": {
          "rbac": {
            "enabled": false
          },
          "system": true
        },
        "functions": [
          {
            "$workflow-run": {
              "workflowName": "event_history",
              "action": "create",
              "data": {
                "eventId": {
                  "$from-context": {
                    "path": "objectId"
                  }
                },
                "actionTitle": "Подтверждение отмены мероприятия",
                "userId": {
                  "$from-context": {
                    "path": "$activeUserId"
                  }
                }
              }
            }
          }
        ],
        "results": {
          "unconditional": "canceled"
        }
      },
      "to_draft": {
        "title": "В черновик",
        "description": "Перевести мероприятие в статус черновик",
        "grants": {
          "rbac": {
            "enabled": true,
            "permissionCode": "event.create"
          }
        },
        "views": {},
        "functions": [
          {
            "$assign-context": {
              "path": "$eventData",
              "data": {
                "$merge": {
                  "data": [
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '' || obj[key] === null) && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.commonInfo"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "Object.keys(obj).forEach((key) => (obj[key] === '' || obj[key] === null) && delete obj[key]); return obj;",
                        "args": {
                          "obj": {
                            "$from-context": {
                              "path": "data.workingHours"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "result = {organizers: [], curators: []}; organizers.forEach((organizer) => {result.organizers.push({ organizerId: organizer.organizerId });}); curators.forEach((curator) => {result.curators.push({ userId: curator.userId });}); return result;",
                        "args": {
                          "organizers": {
                            "$from-context": {
                              "path": "data.organizers"
                            }
                          },
                          "curators": {
                            "$from-context": {
                              "path": "data.curators"
                            }
                          }
                        }
                      }
                    },
                    {
                      "$apply-func": {
                        "func": "$ref:js:prepare-event-files",
                        "args": {
                          "data": {
                            "$from-context": {
                              "path": "data.attachments"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "$api-data-query": {
              "query": "event/update_by_id",
              "variables": {
                "$assign-object": {
                  "path": "data",
                  "data": {
                    "$from-context": {
                      "path": "$eventData"
                    }
                  },
                  "object": {
                    "id": {
                      "$from-context": {
                        "path": "objectId"
                      }
                    }
                  }
                }
              },
              "responsePath": "object"
            }
          }
        ],
        "results": {
          "unconditional": "draft"
        }
      }
    }
  },
  "states": {
    "new": {
      "title": "Новое",
      "description": "Новое мероприятие",
      "displaySettingsInLists": {
        "hidden": true
      },
      "statesActions": [
        "add",
        "to_draft"
      ]
    },
    "draft": {
      "title": "Черновик",
      "description": "Черновое состояние мероприятия",
      "displaySettingsInLists": {
        "hidden": true
      },
      "statesActions": [
        "view",
        "edit",
        "delete",
        "add"
      ]
    },
    "pre_booking": {
      "title": "Предварительная бронь",
      "description": "Мероприятие предварительно забронировано",
      "statesActions": [
        "view",
        "edit",
        "to_requested",
        "view-in-calendar",
        "copy_event",
        "delete",
        "launch-export"
      ]
    },
    "requested": {
      "title": "Получен запрос",
      "description": "Для мероприятия получен запрос",
      "statesActions": [
        "view",
        "edit",
        "to_task_received",
        "copy_event",
        "cancel",
        "view-in-calendar",
        "to_canceled",
        "launch-export"
      ]
    },
    "task_received": {
      "title": "Получено ТЗ",
      "description": "Для мероприятия получено ТЗ",
      "statesActions": [
        "view",
        "edit",
        "to_agreed",
        "copy_event",
        "cancel",
        "view-in-calendar",
        "to_canceled",
        "launch-export"
      ]
    },
    "agreed": {
      "title": "Согласована смета",
      "description": "Для мероприятия согласована смета",
      "statesActions": [
        "view",
        "edit",
        "to_check_in",
        "copy_event",
        "cancel",
        "view-in-calendar",
        "to_canceled",
        "launch-export"
      ]
    },
    "check_in": {
      "title": "Пройден check-in",
      "description": "Мероприятие прошло check-in",
      "statesActions": [
        "view",
        "edit",
        "to_check_out",
        "copy_event",
        "cancel",
        "view-in-calendar",
        "to_canceled",
        "launch-export"
      ]
    },
    "check_out": {
      "title": "Пройден check-out",
      "description": "Мероприятие прошло check-out",
      "statesActions": [
        "view",
        "view-in-calendar",
        "copy_event",
        "launch-export"
      ]
    },
    "canceled": {
      "title": "Отменено",
      "description": "Мероприятие отменено",
      "statesActions": [
        "view",
        "copy_event",
        "launch-export"
      ]
    },
    "deleted": {
      "title": "Удалено",
      "description": "Удаленное состояние мероприятия",
      "displaySettingsInLists": {
        "hidden": true
      },
      "finish": true
    }
  }
}
